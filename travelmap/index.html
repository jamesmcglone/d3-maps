<!DOCTYPE html>
<meta charset="utf-8">

<style>


div.tooltip {   
  position: absolute;           
  text-align: center;   
  box-shadow: 0 0 5px #999999;        
  width: 150px;                  
  height: 20px;                 
  padding: 2px;             
  font-size: 10px;     
  background: lightgreen; /*#FFFFE0; */
  border: 1px;      
  border-radius: 2px;           
  pointer-events: none;         
}

#countries .active {
  fill: orange;
}

#country-borders {
  stroke: #fff;
  stroke-width: 0.1px;
}

</style>

<body>
<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//d3js.org/topojson.v1.min.js"></script>
<!-- <script src="//d3js.org/d3.geo.projection.v0.min.js"></script> -->

<script>

// set dimensions of svg canvas
var width = 1100,
	height = 750;

// define scale to sort countries by total days visited
var color = d3.scale.threshold()
	.domain([1, 2, 4, 8, 16, 32, 1024, 2048]) // for future travel:  64, 128, 256, 512,
	.range([
				// "#ffffd9", //<-- too light for small regions with a white background
				"#edf8b1",
				"#c7e9b4",
				"#7fcdbb",
				"#41b6c4",
				"#1d91c0",
				"#225ea8",
				"#253494",
				"#081d58"
			]);

// random grey color generator 
function getRandomColor() {
    var i = Math.floor((Math.random() * 4));
	var greyscale = ['#DCDCDC','#D3D3D3','#f0f0f0', '#d9d9d9'];
	return greyscale[i];
}

function getTimeScale(daysincountry) {

	if (daysincountry >= 365) {
		return Math.floor(daysincountry/365) + "+ years";
	} else {
		return daysincountry + " days";
	}

}

// append svg canvas to html "body" with declared dimensions
var svg = d3.select("body")
	.append("svg")
    .attr("width", width)
    .attr("height", height);

// labels for mouseover countries
var div = d3.select("body").append("div")   
    .attr("class", "tooltip")               
    .style("opacity", 0);

// assign/append g unit to svg canvas
var g = svg.append("g");

// assign projection and scaling to display clearly
var projection = d3.geo.mercator()
    .scale(175)
    .translate([width / 2, height / 2])
    .precision(.1);

// tweak projection to d3 path formula for drawing map correctly
var geopath = d3.geo.path()
    .projection(projection);

d3.csv("countries.csv", function(data) {

	// grab topojson file, throw error if not accessed/found
	d3.json("world2.json", function(error, world) {
	  if (error) return console.error(error);
	  	
	  	// pair contents of countries.csv with countries in map to add value(s)
		for (var i = 0; i < data.length; i++) {
			var dataCountry = data[i].name;
			var dataDays = data[i].days;

			for (var j = 0; j < world.objects.countries.geometries.length; j++) {
				var mapCountry = world.objects.countries.geometries[j].properties.name;
				var mapDays = world.objects.countries.geometries;

				// add days visited value to countries as a topojson object
				if (dataCountry == mapCountry) {
					world.objects.countries.geometries[j].properties.days = dataDays;
					break;
				}
				// add 0 value for countries that have not been visited
				if (mapDays[j].properties.days > 1) {
					// console.log(mapCountry + ": " + mapDays[j].properties.days);
				} else {
					mapDays[j].properties.days = 0;
				}
			}
		}

		console.log(world);

		g.append("g")
		.attr("id", "countries")
		.selectAll("path")
      	.data(topojson.feature(world, world.objects.countries).features)
      	// topojson v0 --> topojson.object(world, world.objects.countries).geometries)
    	.enter()
      	.append("path")
      	.attr("d", geopath)
      	// .style("stroke", "white") //"#2A2C39")
      	// .style("stroke-width", 0.1)
      	.style("fill", function(d){
      		var travel_days = d.properties.days;

      		if (travel_days) {
      			return color(travel_days);
      		} else {
      			return "#d0a888"; 
      			// other coloring options --> //#e2b279"; //#e5d5b6"; //getRandomColor();
      		} 
      	})
      	.on("mouseover", function(d) {		//Adding mouse events
            div.transition()		
                .duration(200)		
                .style("opacity", .9);		
            div.text(d.properties.name + ": " + getTimeScale(d.properties.days))	
                .style("left", (d3.event.pageX) + "px")		
                .style("top", (d3.event.pageY - 28) + "px");	
        })					
        .on("mouseout", function(d) {		
            div.transition()		
                .duration(500)		
                .style("opacity", 0);	
        });

	    d3.csv("cities.csv", function(error, data) {
	        g.selectAll("circle")
	           .data(data)
	           .enter()
	           .append("circle")
	           .attr("cx", function(d) { //error in console about cx, cx and expected length: 'NaN'
	                   return projection([+d.lon, +d.lat])[0];
	           })
	           .attr("cy", function(d) {
	                   return projection([+d.lon, +d.lat])[1];
	           })
	           .attr("r", 2)
	           .style("fill", "red")
	           .style("opacity", 0.75);

		}); 	
	});
});

</script>